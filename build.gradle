plugins {
  id "org.sonarqube" version "7.1.0.6387"
}

sonar {
  properties {
    property "sonar.projectKey", "opticSquid_broker-risk-management-system"
    property "sonar.organization", "opticsquid-1"
    // 1. DYNAMIC PYTHON COVERAGE
    // Finds all *_coverage.xml files generated by 'uv run pytest' in the root
    def pythonCoverageFiles = fileTree(dir: project.rootDir, include: "*_coverage.xml")
            .collect { it.absolutePath }
            .join(",")
    property "sonar.python.coverage.reportPaths", pythonCoverageFiles

        // 2. DYNAMIC PYTHON SOURCES
        // Scans the ml folder for module directories
        def pythonSrcDirs = file("${project.rootDir}/ml").listFiles()
            ?.findAll { it.isDirectory() }
            ?.collect { it.absolutePath }
            ?.join(",") ?: ""
        
        // 3. COMBINE SOURCES
        // We include the python folders as additional sources for the root project
    property "sonar.sources", pythonSrcDirs
    property "sonar.python.version", "3.13"
  }
}